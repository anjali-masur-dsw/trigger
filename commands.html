<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>

<body>
<script>
Office.onReady(() => {
    console.log("Commands.html loaded");
});

/* =====================================================
   CONFIGURATION - UPDATE THIS URL
===================================================== */
// Replace with your server's URL where the Flask API is running
// Using localhost with self-signed certificate for local development
const API_BASE_URL = "https://localhost:5000";  // Local development

/* =====================================================
   RIBBON ACTION
===================================================== */
async function triggerFlowFromRibbon(event) {
    try {
        Office.context.mailbox.item.notificationMessages.addAsync(
            "progress",
            {
                type: "progressIndicator",
                message: "Analyzing email and uploading to OneDrive..."
            }
        );

        const emailData = await getEmailData();

        // Call your Python API instead of Power Automate
        const apiUrl = `${API_BASE_URL}/process-email`;
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json"
            },
            body: JSON.stringify(emailData)
        });

        Office.context.mailbox.item.notificationMessages.removeAsync("progress");

        if (!response.ok) {
            const err = await response.text();
            throw new Error(`HTTP ${response.status}: ${err}`);
        }

        const result = await response.json();
        
        if (result.success) {
            Office.context.mailbox.item.notificationMessages.addAsync(
                "success",
                {
                    type: "informationalMessage",
                    message: `âœ“ ${result.message}`,
                    icon: "Icon.80x80",
                    persistent: false
                }
            );
        } else {
            throw new Error(result.error || "Processing failed");
        }

    } catch (error) {
        console.error(error);

        Office.context.mailbox.item.notificationMessages.removeAsync("progress");

        Office.context.mailbox.item.notificationMessages.addAsync(
            "error",
            {
                type: "errorMessage",
                message: "Processing failed: " + error.message
            }
        );
        console.log("Error Message: " + error.message)
    } finally {
        event.completed();
    }
}

/* =====================================================
   EMAIL DATA COLLECTION
===================================================== */
async function getEmailData() {
    const item = Office.context.mailbox.item;

    if (!item) throw new Error("No email context");

    const subject = await getSubject(item);
    const body = await getBody(item);
    const attachments = await getAttachmentContents(item);

    return {
        triggeredAt: new Date().toISOString(),
        userEmail: Office.context.mailbox.userProfile.emailAddress || "",
        subject: subject,
        body: body,
        from: getSender(item),
        receivedDateTime:
            item.dateTimeCreated ||
            item.dateTimeModified ||
            new Date().toISOString(),
        internetMessageId: item.internetMessageId || "",
        hasAttachments: attachments.length > 0,
        attachmentCount: attachments.length,
        attachments: attachments
    };
}

/* =====================================================
   HELPERS
===================================================== */
function getSubject(item) {
    return new Promise(resolve => {
        if (typeof item.subject === "string") {
            resolve(item.subject);
        } else {
            item.subject.getAsync(result =>
                resolve(result.status === Office.AsyncResultStatus.Succeeded
                    ? result.value
                    : "Subject unavailable")
            );
        }
    });
}

function getBody(item) {
    return new Promise(resolve => {
        item.body.getAsync(Office.CoercionType.Text, result =>
            resolve(result.status === Office.AsyncResultStatus.Succeeded
                ? result.value
                : "Body unavailable")
        );
    });
}

function getSender(item) {
    if (!item.from) return "Unknown";

    if (typeof item.from === "string") return item.from;
    if (item.from.emailAddress) return item.from.emailAddress;
    if (item.from.displayName) return item.from.displayName;

    return "Unknown";
}

/* =====================================================
   ATTACHMENT CONTENT (BASE64)
===================================================== */
async function getAttachmentContents(item) {
    if (!item.attachments || item.attachments.length === 0) {
        return [];
    }

    const results = [];

    for (const att of item.attachments) {
        await new Promise(resolve => {
            item.getAttachmentContentAsync(att.id, res => {
                if (res.status === Office.AsyncResultStatus.Succeeded) {
                    results.push({
                        id: att.id,
                        name: att.name,
                        contentType: att.contentType,
                        size: att.size,
                        content: res.value.content,   // Base64
                        format: res.value.format
                    });
                } else {
                    results.push({
                        id: att.id,
                        name: att.name,
                        error: res.error.message
                    });
                }
                resolve();
            });
        });
    }

    return results;
}

/* =====================================================
   REGISTER COMMAND
===================================================== */
Office.actions.associate("triggerFlowFromRibbon", triggerFlowFromRibbon);
</script>
</body>
</html>